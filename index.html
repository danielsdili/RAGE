<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Mlátička 2D - NYC Sunset</title>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #111;
      touch-action: none;
      font-family: Arial, sans-serif;
    }

    canvas { display: block; }

    #controls {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 160px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      box-sizing: border-box;
      background: rgba(0,0,0,0.55);
    }

    .left-controls, .right-controls {
      display: flex;
      gap: 15px;
    }

    .btn {
      width: 90px;
      height: 90px;
      border-radius: 20px;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.5);
      color: white;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
    }

    .btn:active { background: rgba(255,255,255,0.55); }

    .big-btn {
      width: 120px;
      height: 120px;
      font-size: 22px;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="controls">
  <div class="left-controls">
    <div class="btn" id="leftBtn">⬅️</div>
    <div class="btn" id="rightBtn">➡️</div>
  </div>

  <div class="right-controls">
    <div class="btn big-btn" id="jumpBtn">JUMP</div>
    <div class="btn big-btn" id="attackBtn">HIT</div>
  </div>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  const controlsHeight = 160;

  const camera = {
    x: 0,
    y: 0,
    zoom: 0.72,
    shake: 0
  };

  const world = {
    width: 3400,
    height: 900
  };

  let groundY = world.height - 180;

  let slowMotionTimer = 0;

  const gravity = 1;
  const jumpStrength = -20;

  // SCORE + COMBO
  let score = 0;
  let combo = 0;
  let comboTimer = 0; // když dojde na 0, combo reset
  let koTextTimer = 0;

  const input = { left:false, right:false, jump:false, attack:false };

  function setButtonEvents(button, keyName) {
    button.addEventListener("touchstart", (e) => {
      e.preventDefault();
      input[keyName] = true;
    });

    button.addEventListener("touchend", (e) => {
      e.preventDefault();
      input[keyName] = false;
    });

    button.addEventListener("touchcancel", (e) => {
      e.preventDefault();
      input[keyName] = false;
    });
  }

  setButtonEvents(document.getElementById("leftBtn"), "left");
  setButtonEvents(document.getElementById("rightBtn"), "right");
  setButtonEvents(document.getElementById("jumpBtn"), "jump");
  setButtonEvents(document.getElementById("attackBtn"), "attack");

  const player = {
    x: 200,
    y: groundY - 120,
    width: 55,
    height: 120,
    speed: 7,
    velocityY: 0,
    onGround: true,
    hp: 100,
    facing: 1,
    attackCooldown: 0,
    attackAnim: 0,
    walkAnim: 0
  };

  const enemies = [];

  function createEnemy(type) {
    const side = Math.random() < 0.5 ? "left" : "right";

    if (type === "fast") {
      return {
        type: "fast",
        x: side === "left" ? 40 : world.width - 80,
        y: groundY - 120,
        width: 50,
        height: 115,
        hp: 35,
        maxHp: 35,
        speed: 4.5,
        alive: true,
        hitCooldown: 0,
        walkAnim: Math.random() * 10,
        color: "#0066ff"
      };
    }

    if (type === "tank") {
      return {
        type: "tank",
        x: side === "left" ? 40 : world.width - 80,
        y: groundY - 140,
        width: 75,
        height: 140,
        hp: 120,
        maxHp: 120,
        speed: 1.3,
        alive: true,
        hitCooldown: 0,
        walkAnim: Math.random() * 10,
        color: "#663300"
      };
    }

    // normal
    return {
      type: "normal",
      x: side === "left" ? 40 : world.width - 80,
      y: groundY - 120,
      width: 55,
      height: 120,
      hp: 60,
      maxHp: 60,
      speed: 2.6,
      alive: true,
      hitCooldown: 0,
      walkAnim: Math.random() * 10,
      color: "#111"
    };
  }

  function spawnEnemy() {
    const r = Math.random();

    if (r < 0.20) enemies.push(createEnemy("tank"));
    else if (r < 0.55) enemies.push(createEnemy("fast"));
    else enemies.push(createEnemy("normal"));
  }

  for (let i = 0; i < 6; i++) spawnEnemy();

  const particles = [];

  function spawnSplash(x, y, amount = 40) {
    for (let i = 0; i < amount; i++) {
      particles.push({
        x: x,
        y: y,
        vx: (Math.random() - 0.5) * 12,
        vy: -Math.random() * 14,
        size: Math.random() * 6 + 2,
        life: 60 + Math.random() * 40
      });
    }
  }

  function rectsCollide(a, b) {
    return (
      a.x < b.x + b.width &&
      a.x + a.width > b.x &&
      a.y < b.y + b.height &&
      a.y + a.height > b.y
    );
  }

  function addScore(enemyType) {
    let base = 100;

    if (enemyType === "fast") base = 140;
    if (enemyType === "tank") base = 220;

    combo++;
    comboTimer = 180; // 3 sekundy

    const comboBonus = combo * 20;
    score += base + comboBonus;

    // KO efekt
    koTextTimer = 40;
    camera.shake = 20;
  }

  function playerAttack() {
    if (player.attackCooldown > 0) return;

    player.attackCooldown = 22;
    player.attackAnim = 12;

    const batHitbox = {
      x: player.facing === 1 ? player.x + player.width : player.x - 90,
      y: player.y + 35,
      width: 90,
      height: 55
    };

    enemies.forEach(enemy => {
      if (!enemy.alive) return;

      if (rectsCollide(batHitbox, enemy)) {
        enemy.hp -= 25;

        // knockback
        enemy.x += player.facing * (enemy.type === "tank" ? 25 : 55);

        spawnSplash(enemy.x + enemy.width / 2, enemy.y + 60, 18);

        if (enemy.hp <= 0) {
          enemy.alive = false;
          spawnSplash(enemy.x + enemy.width / 2, enemy.y + 30, 120);

          slowMotionTimer = 45;

          addScore(enemy.type);

          setTimeout(() => spawnEnemy(), 900);
        }
      }
    });
  }

  function updateCamera() {
    camera.x = player.x - (canvas.width / camera.zoom) / 2;
    camera.y = 0;

    if (camera.x < 0) camera.x = 0;
    if (camera.x > world.width - (canvas.width / camera.zoom)) {
      camera.x = world.width - (canvas.width / camera.zoom);
    }

    // shake
    if (camera.shake > 0) camera.shake--;
  }

  function update() {
    let timeScale = slowMotionTimer > 0 ? 0.45 : 1;
    if (slowMotionTimer > 0) slowMotionTimer--;

    if (player.attackCooldown > 0) player.attackCooldown -= 1 * timeScale;
    if (player.attackAnim > 0) player.attackAnim -= 1 * timeScale;

    if (koTextTimer > 0) koTextTimer -= 1 * timeScale;

    // combo timer
    if (comboTimer > 0) comboTimer -= 1 * timeScale;
    if (comboTimer <= 0) combo = 0;

    // pohyb hráče
    let moving = false;

    if (input.left) {
      player.x -= player.speed * timeScale;
      player.facing = -1;
      moving = true;
    }
    if (input.right) {
      player.x += player.speed * timeScale;
      player.facing = 1;
      moving = true;
    }

    if (moving) player.walkAnim += 0.25 * timeScale;
    else player.walkAnim *= 0.9;

    // skok
    if (input.jump && player.onGround) {
      player.velocityY = jumpStrength;
      player.onGround = false;
    }

    // útok
    if (input.attack) playerAttack();

    // gravitace
    player.velocityY += gravity * timeScale;
    player.y += player.velocityY * timeScale;

    // zem
    if (player.y + player.height >= groundY) {
      player.y = groundY - player.height;
      player.velocityY = 0;
      player.onGround = true;
    }

    // hranice světa
    if (player.x < 0) player.x = 0;
    if (player.x + player.width > world.width) player.x = world.width - player.width;

    // AI nepřátel
    enemies.forEach(enemy => {
      if (!enemy.alive) return;

      if (enemy.hitCooldown > 0) enemy.hitCooldown -= 1 * timeScale;

      let emoving = false;

      if (enemy.x < player.x - 10) {
        enemy.x += enemy.speed * timeScale;
        emoving = true;
      }
      if (enemy.x > player.x + 10) {
        enemy.x -= enemy.speed * timeScale;
        emoving = true;
      }

      if (emoving) enemy.walkAnim += 0.18 * timeScale;

      const dist = Math.abs(enemy.x - player.x);

      // útok nepřítele
      if (dist < 70 && enemy.hitCooldown <= 0) {
        let dmg = 5;
        if (enemy.type === "fast") dmg = 4;
        if (enemy.type === "tank") dmg = 9;

        player.hp -= dmg;
        enemy.hitCooldown = enemy.type === "fast" ? 50 : 75;

        spawnSplash(player.x + player.width / 2, player.y + 70, 8);
        player.x += (enemy.x < player.x ? 25 : -25);
      }
    });

    // particles
    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.vy += 0.6 * timeScale;
      p.x += p.vx * timeScale;
      p.y += p.vy * timeScale;
      p.life -= 1 * timeScale;

      if (p.y > groundY) {
        p.y = groundY;
        p.vy *= -0.25;
        p.vx *= 0.7;
      }

      if (p.life <= 0) particles.splice(i, 1);
    }

    if (player.hp <= 0) player.hp = 0;

    updateCamera();
  }

  // --- DRAW ---

  function drawNYBackground() {
    const sky = ctx.createLinearGradient(0, 0, 0, world.height);
    sky.addColorStop(0, "#ff914d");
    sky.addColorStop(0.5, "#ff4f7b");
    sky.addColorStop(1, "#2a1d5f");

    ctx.fillStyle = sky;
    ctx.fillRect(0, 0, world.width, world.height);

    ctx.fillStyle = "rgba(255, 220, 120, 0.9)";
    ctx.beginPath();
    ctx.arc(650, 200, 110, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "rgba(0,0,0,0.65)";
    for (let i = 0; i < 90; i++) {
      const bx = i * 38;
      const bh = 200 + Math.random() * 260;
      ctx.fillRect(bx, groundY - bh, 34, bh);
    }

    ctx.fillStyle = "rgba(255,255,180,0.45)";
    for (let i = 0; i < 250; i++) {
      const wx = Math.random() * world.width;
      const wy = (groundY - 450) + Math.random() * 350;
      ctx.fillRect(wx, wy, 4, 4);
    }
  }

  function drawShadow(x, y, w) {
    ctx.fillStyle = "rgba(0,0,0,0.3)";
    ctx.beginPath();
    ctx.ellipse(x + w/2, y + (w > 60 ? 138 : 118), 22 + (w > 60 ? 8 : 0), 8, 0, 0, Math.PI * 2);
    ctx.fill();
  }

  function drawCharacter(entity, shirtColor, walkAnim) {
    const x = entity.x;
    const y = entity.y;
    const w = entity.width;
    const h = entity.height;

    const legSwing = Math.sin(walkAnim) * 6;

    drawShadow(x, y, w);

    // nohy
    ctx.fillStyle = "#222";
    ctx.fillRect(x + 10 + legSwing, y + h - 40, 12, 40);
    ctx.fillRect(x + w - 22 - legSwing, y + h - 40, 12, 40);

    // tělo
    ctx.fillStyle = shirtColor;
    ctx.fillRect(x + 5, y + 40, w - 10, 55);

    // ruce
    ctx.fillStyle = "#f2c9a0";
    ctx.fillRect(x - 5, y + 50, 12, 40);
    ctx.fillRect(x + w - 7, y + 50, 12, 40);

    // hlava
    ctx.fillStyle = "#f2c9a0";
    ctx.beginPath();
    ctx.arc(x + w/2, y + 20, 18, 0, Math.PI * 2);
    ctx.fill();

    // oči
    ctx.fillStyle = "black";
    ctx.fillRect(x + w/2 - 8, y + 15, 4, 4);
    ctx.fillRect(x + w/2 + 4, y + 15, 4, 4);
  }

  function drawBat() {
    ctx.strokeStyle = "#8b5a2b";
    ctx.lineWidth = 10;

    let batX1 = player.x + player.width / 2;
    let batY1 = player.y + 70;

    let swing = 0;
    if (player.attackAnim > 0) {
      swing = Math.sin((12 - player.attackAnim) / 12 * Math.PI) * 40;
    }

    let batX2 = batX1 + player.facing * (75 + swing);
    let batY2 = batY1 - 15 - swing * 0.4;

    ctx.beginPath();
    ctx.moveTo(batX1, batY1);
    ctx.lineTo(batX2, batY2);
    ctx.stroke();
  }

  function drawHealthBar(x, y, w, h, hp, maxHp) {
    ctx.fillStyle = "rgba(0,0,0,0.7)";
    ctx.fillRect(x, y, w, h);

    const fill = Math.max(0, (hp / maxHp) * w);
    ctx.fillStyle = "lime";
    ctx.fillRect(x, y, fill, h);
  }

  function drawUI() {
    // HP
    drawHealthBar(20, 20, 220, 18, player.hp, 100);

    // SCORE
    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("SCORE: " + score, 20, 70);

    // COMBO
    if (combo > 1) {
      ctx.fillStyle = "yellow";
      ctx.font = "26px Arial";
      ctx.fillText("COMBO x" + combo, 20, 105);
    }
  }

  function drawKO() {
    if (koTextTimer <= 0) return;

    const scale = 1 + Math.sin((40 - koTextTimer) / 40 * Math.PI) * 0.3;

    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2 - 120);
    ctx.scale(scale, scale);

    ctx.fillStyle = "rgba(0,0,0,0.6)";
    ctx.font = "90px Arial";
    ctx.fillText("KO!", -95, 0);

    ctx.fillStyle = "red";
    ctx.font = "90px Arial";
    ctx.fillText("KO!", -100, -5);

    ctx.restore();
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // shake offset
    let shakeX = 0;
    let shakeY = 0;
    if (camera.shake > 0) {
      shakeX = (Math.random() - 0.5) * camera.shake;
      shakeY = (Math.random() - 0.5) * camera.shake;
    }

    ctx.save();
    ctx.scale(camera.zoom, camera.zoom);
    ctx.translate(-camera.x + shakeX, -camera.y + shakeY);

    drawNYBackground();

    // zem
    ctx.fillStyle = "#444";
    ctx.fillRect(0, groundY, world.width, world.height - groundY);

    // hráč
    drawCharacter(player, "#ff3333", player.walkAnim);
    drawBat();

    // nepřátelé
    enemies.forEach(enemy => {
      if (!enemy.alive) return;

      drawCharacter(enemy, enemy.color, enemy.walkAnim);
      drawHealthBar(enemy.x, enemy.y - 20, 60, 10, enemy.hp, enemy.maxHp);
    });

    // particles
    ctx.fillStyle = "red";
    particles.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    });

    ctx.restore();

    // UI
    drawUI();
    drawKO();

    if (slowMotionTimer > 0) {
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.font = "50px Arial";
      ctx.fillText("SLOMO!", canvas.width / 2 - 100, 120);
    }

    if (player.hp <= 0) {
      ctx.fillStyle = "rgba(0,0,0,0.7)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "white";
      ctx.font = "60px Arial";
      ctx.fillText("GAME OVER", canvas.width / 2 - 170, canvas.height / 2);

      ctx.font = "30px Arial";
      ctx.fillText("Final Score: " + score, canvas.width / 2 - 110, canvas.height / 2 + 60);
    }
  }

  function gameLoop() {
    update();
    draw();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>

</body>
</html>
